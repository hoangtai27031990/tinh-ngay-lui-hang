<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T√≠nh Ng√†y L√πi H√†ng</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body { background:#f5f7fb; }
.card { background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
.warning {color:#dc2626;font-weight:700;}
</style>
</head>

<body class="p-4 max-w-xl mx-auto">

<!-- HEADER -->
<div class="flex items-center gap-3 mb-4">
  <img src="logo.png" class="h-10" onerror="this.style.display='none'">
  <h1 class="text-xl font-bold text-slate-800">T√çNH NG√ÄY L√ôI H√ÄNG</h1>
</div>

<!-- CARD -->
<div class="card p-4 space-y-3">

<label class="block">Barcode</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="bg-blue-600 text-white px-3 rounded">üì∑</button>
</div>

<div id="reader" class="mt-2"></div>

<label>Ng√†y s·∫£n xu·∫•t</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label>H·∫°n s·ª≠ d·ª•ng</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<button onclick="calculate()" class="bg-green-600 text-white py-2 rounded w-full mt-2">
T√≠nh k·∫øt qu·∫£
</button>

<div id="result" class="text-center font-semibold mt-2"></div>

<button onclick="exportExcel()" class="bg-gray-700 text-white py-2 rounded w-full mt-2">
Xu·∫•t Excel l·ªãch s·ª≠
</button>

<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded w-full mt-2">
X√≥a to√†n b·ªô l·ªãch s·ª≠
</button>

</div>

<!-- HISTORY -->
<div class="card p-3 mt-4">
<h2 class="font-bold mb-2">L·ªãch s·ª≠ t√≠nh</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

<script>
const historyKey = "tinh_ngay_lui_history";

function calculate(){
 const nsx = new Date(nsxInput.value);
 const hsd = new Date(hsdInput.value);
 if(!nsxInput.value || !hsdInput.value){
   alert("Nh·∫≠p ƒë·ªß NSX & HSD");
   return;
 }

 const totalDays = (hsd - nsx)/(1000*3600*24);
 const limitDays = totalDays * 0.8;
 const displayDate = new Date(nsx.getTime() + limitDays*24*3600*1000);

 const today = new Date();
 let warning = displayDate < today;

 result.innerHTML = `
Ng√†y tr∆∞ng b√†y cu·ªëi: <b>${displayDate.toLocaleDateString()}</b>
${warning ? '<div class="warning">‚ö† S·∫¢N PH·∫®M D∆Ø·ªöI 20% HSD</div>' : ''}
 `;

 saveHistory(displayDate, warning);
}

function saveHistory(date, warning){
 let history = JSON.parse(localStorage.getItem(historyKey)||"[]");

 history.unshift({
  barcode: barcode.value,
  nsx: nsxInput.value,
  hsd: hsdInput.value,
  display: date.toLocaleDateString(),
  warning,
  time: new Date().toLocaleString()
 });

 localStorage.setItem(historyKey, JSON.stringify(history));
 renderHistory();
}

function renderHistory(){
 const history = JSON.parse(localStorage.getItem(historyKey)||"[]");
 historyDiv.innerHTML = history.map(h=>`
<div class="border-b pb-1 ${h.warning?'warning':''}">
üì¶ ${h.barcode||'---'} | ${h.display} | ${h.time}
</div>
`).join("");
}

function clearHistory(){
 if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠?")){
   localStorage.removeItem(historyKey);
   renderHistory();
 }
}

function exportExcel(){
 const history = JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!history.length){ alert("Kh√¥ng c√≥ d·ªØ li·ªáu"); return; }

 const ws = XLSX.utils.json_to_sheet(history);
 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "LichSu");
 XLSX.writeFile(wb, "lich_su_tinh_ngay_lui.xlsx");
}

/* BARCODE */
let html5Qr;
function startScan(){
 document.getElementById("reader").innerHTML="";
 html5Qr = new Html5Qrcode("reader");
 html5Qr.start({ facingMode: "environment" }, { fps:10, qrbox:250 },
  code=>{
    barcode.value=code;
    html5Qr.stop();
  },
  err=>{}
 );
}

const nsxInput = document.getElementById("nsx");
const hsdInput = document.getElementById("hsd");
const barcode = document.getElementById("barcode");
const result = document.getElementById("result");
const historyDiv = document.getElementById("history");

renderHistory();
</script>

</body>
</html>
