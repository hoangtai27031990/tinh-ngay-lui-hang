<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}
.warning20{color:#b91c1c;font-weight:700}
.warning30{color:#c2410c;font-weight:700}

/* ===== M·ªêC 30% ‚Äì CAM ƒê·∫¨M + NHANH + VI·ªÄN NH·∫§P NH√ÅY ===== */
.blink30{
  animation: blink30 0.6s linear infinite;
  border:2px solid #fb923c;
}

@keyframes blink30{
  0%{
    background:#fff3e0;
    box-shadow:0 0 0 rgba(251,146,60,0);
  }
  50%{
    background:#ff9800;
    box-shadow:
      0 0 18px rgba(251,146,60,1),
      0 0 32px rgba(251,146,60,.9);
  }
  100%{
    background:#fff3e0;
    box-shadow:0 0 0 rgba(251,146,60,0);
  }
}

/* ===== M·ªêC 20% ‚Äì ƒê·ªé M·∫†NH ===== */
.blink20{
  animation: blink20 .7s ease-in-out infinite;
}

@keyframes blink20{
  0%,100%{background:#fff1f2;box-shadow:0 0 0 rgba(239,68,68,0)}
  50%{background:#fee2e2;box-shadow:0 0 18px rgba(239,68,68,1)}
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<div class="flex items-center gap-3 mb-4 p-3 rounded-lg brand-bg text-white">
  <div>
    <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
    <div class="text-sm opacity-90">Saigon Co.op ‚Äì Ki·ªÉm so√°t h·∫°n s·ª≠ d·ª•ng</div>
  </div>
</div>

<div class="card p-4 space-y-3">

<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden mt-2"></div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded font-semibold">T√çNH L·∫†I</button>
</div>

<div id="result" class="pt-2"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm pt-2"></div>
</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠ t√≠nh to√°n</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

<script>
const historyKey="coop_hsd_history";

const barcodeInput=document.getElementById("barcode");
const nsxInput=document.getElementById("nsx");
const hsdInput=document.getElementById("hsd");
const resultDiv=document.getElementById("result");
const historyDiv=document.getElementById("history");
const statDiv=document.getElementById("statistic");

let html5Qr=null;

async function startScan(){
 const reader=document.getElementById("reader");
 reader.classList.remove("hidden");

 if(!html5Qr) html5Qr=new Html5Qrcode("reader");

 html5Qr.start({facingMode:"environment"},{fps:10,qrbox:250},
 code=>{
   barcodeInput.value=code;

   if(navigator.vibrate) navigator.vibrate(200);
   new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play().catch(()=>{});

   if(navigator.userAgent.toLowerCase().includes("zalo")){
     alert("‚ö† Zalo h·∫°n ch·∫ø camera. N√™n m·ªü b·∫±ng Chrome/Safari ƒë·ªÉ qu√©t ·ªïn ƒë·ªãnh.");
   }

   html5Qr.stop();
   reader.classList.add("hidden");
 },()=>{});
}

function calculate(){
 const nsxVal=nsxInput.value;
 const hsdVal=hsdInput.value;
 if(!nsxVal||!hsdVal){alert("Nh·∫≠p ƒë·ªß NSX & HSD");return;}

 const nsx=new Date(nsxVal);
 const hsd=new Date(hsdVal);
 if(hsd<=nsx){alert("HSD ph·∫£i l·ªõn h∆°n NSX");return;}

 const totalDays=(hsd-nsx)/86400000;
 const date30=new Date(nsx.getTime()+totalDays*0.7*86400000);
 const date20=new Date(nsx.getTime()+totalDays*0.8*86400000);
 const today=new Date();

 let warn30="",warn20="",blink30="",blink20="";
 let flag30="B√¨nh th∆∞·ªùng",flag20="B√¨nh th∆∞·ªùng";

 if(today>=date30){
   warn30=`<div class="warning30 mt-1">‚ö† C·∫£nh b√°o: Gi·∫£i t·ªìn</div>`;
   blink30="blink30";
   flag30="Gi·∫£i t·ªìn";
 }

 if(today>=date20){
   warn20=`<div class="warning20 mt-1">‚ö† C·∫£nh b√°o: R√∫t h√†ng</div>`;
   blink20="blink20";
   flag20="R√∫t h√†ng";
 }

 resultDiv.innerHTML=`
<div class="border rounded-lg p-3 mb-3 ${blink30}">
<b>M·ªêC 30%</b><br>üìÖ ${date30.toLocaleDateString("vi-VN")}
${warn30||"<div class='text-green-700 mt-1'>Trong ng∆∞·ª°ng an to√†n</div>"}
</div>

<div class="border rounded-lg p-3 ${blink20}">
<b>M·ªêC 20% (L√ôI H√ÄNG)</b><br>üìÖ ${date20.toLocaleDateString("vi-VN")}
${warn20||"<div class='text-green-700 mt-1'>Trong ng∆∞·ª°ng an to√†n</div>"}
</div>
`;

 saveHistory(flag30,flag20);
}

function saveHistory(f30,f20){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");

 h.unshift({
  Barcode: barcodeInput.value,
  NSX: nsxInput.value,
  HSD: hsdInput.value,
  "C·∫£nh b√°o 30%": f30,
  "C·∫£nh b√°o 20%": f20,
  "Th·ªùi gian": new Date().toLocaleString("vi-VN")
 });

 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 historyDiv.innerHTML=h.map(x=>`
<div class="border-b pb-1">
<b>${x.Barcode||"-"}</b> | 30%: ${x["C·∫£nh b√°o 30%"]} | 20%: ${x["C·∫£nh b√°o 20%"]}
</div>`).join("");

 statDiv.innerHTML=`üì¶ T·ªïng b·∫£n ghi: <b>${h.length}</b>`;
}

function clearHistory(){
 if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠?")){
   localStorage.removeItem(historyKey);
   renderHistory();
 }
}

function exportExcel(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!h.length){alert("Kh√¥ng c√≥ d·ªØ li·ªáu");return;}

 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}

function resetForm(){
 barcodeInput.value="";
 nsxInput.value="";
 hsdInput.value="";
 resultDiv.innerHTML="";
}

renderHistory();
</script>

</body>
</html>
