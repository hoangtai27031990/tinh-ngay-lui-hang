<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}
.warning20{color:#b91c1c;font-weight:700}
.warning30{color:#d97706;font-weight:700}

.blink30{animation:blink30 1.5s ease-in-out infinite}
@keyframes blink30{0%,100%{opacity:1}50%{opacity:.6}}

.blink20{
 animation:blink20 .8s ease-in-out infinite;
 border-color:#dc2626!important;
}
@keyframes blink20{
 0%{box-shadow:0 0 0 rgba(220,38,38,0);background:#fff1f2}
 50%{box-shadow:0 0 16px rgba(220,38,38,.9);background:#fee2e2}
 100%{box-shadow:0 0 0 rgba(220,38,38,0);background:#fff1f2}
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<div class="flex items-center gap-3 mb-4 p-3 rounded-lg brand-bg text-white">
  <div>
    <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
    <div class="text-sm opacity-90">Saigon Co.op ‚Äì Ki·ªÉm so√°t h·∫°n s·ª≠ d·ª•ng</div>
  </div>
</div>

<div class="card p-4 space-y-3">

<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden mt-2"></div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded font-semibold">T√çNH L·∫†I</button>
</div>

<div id="result" class="pt-2"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm pt-2"></div>
</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠ t√≠nh to√°n</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

<script>
const historyKey="coop_hsd_history";
const nsxInput=nsx.value, hsdInput=hsd.value;

let html5Qr=null;

async function startScan(){
 document.getElementById("reader").classList.remove("hidden");

 if(!html5Qr) html5Qr=new Html5Qrcode("reader");

 html5Qr.start({facingMode:"environment"},{fps:10,qrbox:250},
 code=>{
   barcode.value=code;

   if(navigator.vibrate) navigator.vibrate(200);

   const audio=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
   audio.play().catch(()=>{});

   if(navigator.userAgent.toLowerCase().includes("zalo")){
     alert("‚ö† L∆∞u √Ω: Zalo h·∫°n ch·∫ø camera ‚Äì n·∫øu qu√©t kh√¥ng ·ªïn ƒë·ªãnh h√£y m·ªü b·∫±ng Chrome/Safari.");
   }

   html5Qr.stop();
   document.getElementById("reader").classList.add("hidden");
 },()=>{});
}

function calculate(){
 const nsxVal=nsx.value, hsdVal=hsd.value;
 if(!nsxVal||!hsdVal) return alert("Nh·∫≠p ƒë·ªß NSX & HSD");

 const nsxDate=new Date(nsxVal), hsdDate=new Date(hsdVal);
 if(hsdDate<=nsxDate) return alert("HSD ph·∫£i l·ªõn h∆°n NSX");

 const totalDays=(hsdDate-nsxDate)/86400000;
 const date30=new Date(nsxDate.getTime()+totalDays*0.7*86400000);
 const date20=new Date(nsxDate.getTime()+totalDays*0.8*86400000);
 const today=new Date();

 let warn30="",warn20="",blink30="",blink20="",level="safe";

 if(today>=date30){
  warn30=`<div class="warning30 mt-1">‚ö† C·∫£nh b√°o: Th√¥ng tin qu·∫£n l√Ω gi·∫£i t·ªìn</div>`;
  blink30="blink30"; level="30";
 }

 if(today>=date20){
  warn20=`<div class="warning20 mt-1">‚ö† D∆∞·ªõi 20% HSD ‚Äì X·ª≠ l√Ω theo quy ƒë·ªãnh</div>`;
  blink20="blink20"; level="20";
 }

 result.innerHTML=`
<div class="border rounded-lg p-3 mb-3 bg-amber-50 ${blink30}">
<b>M·ªêC 30%</b><br>üìÖ ${date30.toLocaleDateString("vi-VN")}
${warn30||"<div class='text-green-700 mt-1'>‚úì Ch∆∞a ƒë·∫øn ng∆∞·ª°ng</div>"}
</div>

<div class="border rounded-lg p-3 bg-red-50 ${blink20}">
<b>M·ªêC 20% (L√ôI H√ÄNG)</b><br>üìÖ ${date20.toLocaleDateString("vi-VN")}
${warn20||"<div class='text-green-700 mt-1'>‚úì Ch∆∞a ƒë·∫øn ng∆∞·ª°ng</div>"}
</div>
`;

 saveHistory(date30,date20,level);
}

function saveHistory(d30,d20,level){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 h.unshift({
  barcode:barcode.value,
  m30:d30.toLocaleDateString("vi-VN"),
  m20:d20.toLocaleDateString("vi-VN"),
  level,time:new Date().toLocaleString("vi-VN")
 });
 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 history.innerHTML=h.map(x=>`<div>${x.barcode||'---'} | 30%:${x.m30} | 20%:${x.m20}</div>`).join("");
 statistic.innerHTML=`üì¶ SP c·∫ßn gi·∫£i t·ªìn (‚â§30%): <b>${h.filter(x=>x.level!="safe").length}</b>`;
}

function exportExcel(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}

function clearHistory(){
 if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠?")){
  localStorage.removeItem(historyKey);
  renderHistory();
 }
}

function resetForm(){
 barcode.value=""; nsx.value=""; hsd.value=""; result.innerHTML="";
}

renderHistory();
</script>

</body>
</html>
