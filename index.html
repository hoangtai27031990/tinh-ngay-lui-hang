<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hệ thống quản lý HSD – Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body { background:#f3f4f6; }
.card { background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08);}
.warning {color:#b91c1c;font-weight:700;}
.brand-bg { background:#c40018; }
.brand-text { color:#c40018; }
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- HEADER -->
<div class="flex items-center gap-3 mb-4 p-3 rounded-lg brand-bg text-white">
  <img src="logo.png" class="h-10 bg-white p-1 rounded" onerror="this.style.display='none'">
  <div>
    <div class="font-bold text-lg">HỆ THỐNG QUẢN LÝ HSD</div>
    <div class="text-sm opacity-90">Saigon Co.op – Kiểm soát hạn sử dụng hàng hóa</div>
  </div>
</div>

<!-- FORM -->
<div class="card p-4 space-y-3">

<div>
<label class="font-semibold">Barcode sản phẩm</label>
<div class="flex gap-2 mt-1">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Quét</button>
</div>
</div>

<div id="reader"></div>

<div>
<label class="font-semibold">Ngày sản xuất (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full mt-1">
</div>

<div>
<label class="font-semibold">Hạn sử dụng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full mt-1">
</div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold">
TÍNH KẾT QUẢ
</button>

<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded font-semibold">
TÍNH LẠI
</button>
</div>

<div id="result" class="text-center font-semibold pt-2"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">
Xuất Excel
</button>

<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">
Xóa lịch sử
</button>
</div>

</div>

<!-- HISTORY -->
<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">Lịch sử tính toán</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

<script>
const historyKey = "coop_ngay_lui_history";

function calculate(){
 const nsxVal = nsxInput.value;
 const hsdVal = hsdInput.value;

 if(!nsxVal || !hsdVal){
   alert("Vui lòng nhập đầy đủ NSX và HSD");
   return;
 }

 const nsx = new Date(nsxVal);
 const hsd = new Date(hsdVal);

 if(hsd <= nsx){
   alert("HSD phải lớn hơn NSX");
   return;
 }

 const totalDays = (hsd - nsx)/(1000*3600*24);
 const limitDays = totalDays * 0.8;
 const displayDate = new Date(nsx.getTime() + limitDays*24*3600*1000);

 const today = new Date();
 let warning = displayDate < today;

 result.innerHTML = `
<div>Ngày trưng bày cuối:</div>
<div class="text-lg">${displayDate.toLocaleDateString('vi-VN')}</div>
${warning 
  ? '<div class="warning mt-1">⚠ DƯỚI 20% HSD – ĐỀ XUẤT XỬ LÝ THEO QUY ĐỊNH</div>' 
  : '<div class="text-green-700 mt-1">✓ Còn trong ngưỡng an toàn</div>'
}
`;

 saveHistory(displayDate, warning);
}

function resetForm(){
 barcode.value = "";
 nsxInput.value = "";
 hsdInput.value = "";
 result.innerHTML = "";
}

function saveHistory(date, warning){
 let history = JSON.parse(localStorage.getItem(historyKey)||"[]");

 history.unshift({
  barcode: barcode.value || "",
  nsx: nsxInput.value,
  hsd: hsdInput.value,
  display: date.toLocaleDateString('vi-VN'),
  warning,
  time: new Date().toLocaleString('vi-VN')
 });

 localStorage.setItem(historyKey, JSON.stringify(history));
 renderHistory();
}

function renderHistory(){
 const history = JSON.parse(localStorage.getItem(historyKey)||"[]");
 historyDiv.innerHTML = history.map(h=>`
<div class="border-b pb-1 ${h.warning?'warning':''}">
<b>${h.barcode || '---'}</b> | ${h.display} | ${h.time}
</div>
`).join("");
}

function clearHistory(){
 if(confirm("Xác nhận xóa toàn bộ lịch sử?")){
   localStorage.removeItem(historyKey);
   renderHistory();
 }
}

function exportExcel(){
 const history = JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!history.length){ alert("Không có dữ liệu để xuất"); return; }

 const ws = XLSX.utils.json_to_sheet(history);
 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "LichSu");
 XLSX.writeFile(wb, "saigoncoop_quan_ly_hsd.xlsx");
}

/* BARCODE */
let html5Qr;
function startScan(){
 document.getElementById("reader").innerHTML="";
 html5Qr = new Html5Qrcode("reader");
 html5Qr.start({ facingMode: "environment" }, { fps:10, qrbox:250 },
  code=>{
    barcode.value=code;
    html5Qr.stop();
  },
  err=>{}
 );
}

const nsxInput = document.getElementById("nsx");
const hsdInput = document.getElementById("hsd");
const barcode = document.getElementById("barcode");
const result = document.getElementById("result");
const historyDiv = document.getElementById("history");

renderHistory();
</script>

</body>
</html>
