<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}
.warning20{color:#b91c1c;font-weight:700}
.warning30{color:#d97706;font-weight:700}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- HEADER -->
<div class="flex items-center gap-3 mb-4 p-3 rounded-lg brand-bg text-white">
  <img src="logo.png" class="h-10 bg-white p-1 rounded" onerror="this.style.display='none'">
  <div>
    <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
    <div class="text-sm opacity-90">Saigon Co.op ‚Äì Ki·ªÉm so√°t h·∫°n s·ª≠ d·ª•ng</div>
  </div>
</div>

<!-- FORM -->
<div class="card p-4 space-y-3">

<div>
<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2 mt-1">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>
</div>

<div>
<label class="font-semibold">Camera</label>
<select id="cameraSelect" class="border p-2 rounded w-full mt-1"></select>
</div>

<div id="reader" class="hidden mt-2"></div>

<div>
<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full mt-1">
</div>

<div>
<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full mt-1">
</div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded font-semibold">T√çNH L·∫†I</button>
</div>

<div id="result" class="text-center font-semibold pt-2"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm pt-2"></div>

</div>

<!-- HISTORY -->
<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠ t√≠nh to√°n</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

<script>
const historyKey="coop_hsd_history";
const nsxInput=document.getElementById("nsx");
const hsdInput=document.getElementById("hsd");
const barcode=document.getElementById("barcode");
const result=document.getElementById("result");
const historyDiv=document.getElementById("history");
const statDiv=document.getElementById("statistic");
const reader=document.getElementById("reader");
const cameraSelect=document.getElementById("cameraSelect");

let html5Qr=null;

/* CAMERA */
Html5Qrcode.getCameras().then(cams=>{
 cams.forEach(c=>{
  const op=document.createElement("option");
  op.value=c.id; op.text=c.label||"Camera";
  cameraSelect.appendChild(op);
 });
});

async function startScan(){
 reader.classList.remove("hidden");
 if(html5Qr) await html5Qr.stop().catch(()=>{});

 html5Qr=new Html5Qrcode("reader");
 const camId=cameraSelect.value;

 html5Qr.start(camId,{fps:10,qrbox:250},
  async code=>{
   barcode.value=code;
   await html5Qr.stop().catch(()=>{});
   reader.classList.add("hidden");
  },()=>{}
 );
}

/* CALCULATE */
function calculate(){
 const nsxVal=nsxInput.value;
 const hsdVal=hsdInput.value;
 if(!nsxVal||!hsdVal){alert("Nh·∫≠p ƒë·ªß NSX v√† HSD");return;}

 const nsx=new Date(nsxVal);
 const hsd=new Date(hsdVal);
 if(hsd<=nsx){alert("HSD ph·∫£i l·ªõn h∆°n NSX");return;}

 const totalDays=(hsd-nsx)/(1000*3600*24);
 const date30=new Date(nsx.getTime()+totalDays*0.7*86400000);
 const date20=new Date(nsx.getTime()+totalDays*0.8*86400000);
 const today=new Date();

 let level="safe";
 if(today>=date20) level="20";
 else if(today>=date30) level="30";

 let msg="";
 if(level==="20") msg=`<div class="warning20">‚ö† D∆Ø·ªöI 20% HSD ‚Äì ƒê·ªÄ XU·∫§T X·ª¨ L√ù THEO QUY ƒê·ªäNH</div>`;
 else if(level==="30") msg=`<div class="warning30">‚ö† C·∫¢NH B√ÅO: TH√îNG TIN ƒê·∫æN QU·∫¢N L√ù GI·∫¢I T·ªíN</div>`;
 else msg=`<div class="text-green-700">‚úì C√≤n trong ng∆∞·ª°ng an to√†n</div>`;

 result.innerHTML=`
<div>Ng√†y m·ªëc 30%: ${date30.toLocaleDateString('vi-VN')}</div>
<div>Ng√†y m·ªëc 20%: ${date20.toLocaleDateString('vi-VN')}</div>
${msg}`;

 saveHistory(date30,date20,level);
}

function resetForm(){
 barcode.value=""; nsxInput.value=""; hsdInput.value=""; result.innerHTML="";
}

/* HISTORY */
function saveHistory(d30,d20,level){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 h.unshift({
  barcode:barcode.value||"",
  nsx:nsxInput.value,
  hsd:hsdInput.value,
  m30:d30.toLocaleDateString('vi-VN'),
  m20:d20.toLocaleDateString('vi-VN'),
  level,
  time:new Date().toLocaleString('vi-VN')
 });
 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 historyDiv.innerHTML=h.map(x=>`
<div class="border-b pb-1 ${x.level==='20'?'warning20':x.level==='30'?'warning30':''}">
<b>${x.barcode||'---'}</b> | 30%:${x.m30} | 20%:${x.m20}
</div>`).join("");

 const count30=h.filter(x=>x.level==="30"||x.level==="20").length;
 statDiv.innerHTML=`üì¶ S·∫£n ph·∫©m c·∫ßn gi·∫£i t·ªìn (‚â§30%): <b>${count30}</b>`;
}

function clearHistory(){
 if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠?")){
  localStorage.removeItem(historyKey);
  renderHistory();
 }
}

/* EXPORT */
function exportExcel(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!h.length){alert("Kh√¥ng c√≥ d·ªØ li·ªáu");return;}

 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}

renderHistory();
</script>

</body>
</html>
