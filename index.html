<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

.chat-box{height:420px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;margin-bottom:6px;font-family:monospace}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer;font-size:13px}
.filter-btn.active{background:#2563eb;color:white;border-color:#2563eb}

#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center">
  <div id="popupBox">
    <div id="popupTitle" class="font-bold text-lg mb-2"></div>
    <div id="popupMsg" class="mb-4"></div>
    <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">ƒê√£ hi·ªÉu</button>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar">
  <div class="p-4 border-b text-center">
    <img src="logo.png" width="140" class="mx-auto mb-2">
    <div class="font-bold brand-text">Saigon Co.op</div>
  </div>
  <div class="p-3 space-y-2">
    <button onclick="showMain()" class="w-full text-left px-3 py-2 rounded bg-red-50">üì¶ Qu·∫£n l√Ω HSD</button>
    <button onclick="showPrint()" class="w-full text-left px-3 py-2 rounded bg-slate-100">üñ® In b·∫£ng gi√° qu·∫ßy</button>
  </div>
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="flex items-center gap-2">
    <img src="logo.png" class="h-8 bg-white rounded p-1">
    <div>
      <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
      <div class="text-sm opacity-90">Saigon Co.op</div>
    </div>
  </div>
  <button onclick="toggleMenu()" class="text-2xl">‚ò∞</button>
</div>

<!-- ===== MAIN APP (GI·ªÆ NGUY√äN) ===== -->
<div id="mainApp">
  <!-- ph·∫ßn qu·∫£n l√Ω HSD c·ªßa b·∫°n gi·ªØ nguy√™n -->
</div>

<!-- ===== PRINT APP ===== -->
<div id="printApp" class="hidden card p-4">

<h2 class="font-bold brand-text mb-3">In b·∫£ng gi√° qu·∫ßy</h2>

<div class="flex flex-wrap gap-2 mb-2">
<button onclick="startPrintScan()" class="brand-bg text-white px-3 py-2 rounded">üì∑ Qu√©t barcode</button>
<button onclick="exportText()" class="bg-slate-700 text-white px-3 py-2 rounded">‚¨á Xu·∫•t TXT</button>
<button onclick="clearPrintHistory()" class="bg-red-600 text-white px-3 py-2 rounded">üóë X√≥a</button>
</div>

<div id="printReader" class="hidden mb-2"></div>
<div class="chat-box" id="printHistory"></div>

</div>

<script>
const printKey="coop_print_history";

/* ===== EXPORT TXT ‚Äì FINAL FIX ===== */
function exportText(){
  const d = JSON.parse(localStorage.getItem(printKey) || "{}");
  if(!Object.keys(d).length){
    alert("Kh√¥ng c√≥ d·ªØ li·ªáu");
    return;
  }

  const txt = Object.entries(d)
    .map(([b,q]) => `${b},${q}`)
    .join("\n");

  const blob = new Blob([txt], { type:"text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "barcode_print.txt";
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  localStorage.removeItem(printKey);
  renderPrint();

  showPopup("export");
}

/* ===== POPUP ===== */
function showPopup(type){
 const popup=document.getElementById("alertPopup");
 const box=document.getElementById("popupBox");
 const title=document.getElementById("popupTitle");
 const msg=document.getElementById("popupMsg");

 box.className="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center";

 if(type==="export"){
   title.innerText="‚úÖ XU·∫§T FILE TH√ÄNH C√îNG";
   msg.innerText="Danh s√°ch ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ v√† h·ªá th·ªëng ƒë√£ s·∫µn s√†ng cho ƒë·ª£t qu√©t m·ªõi.";
 }

 popup.classList.remove("hidden");
 popup.classList.add("flex");

 if(type==="export"){
   setTimeout(closePopup, 2500);
 }
}

function closePopup(){
 alertPopup.classList.add("hidden");
 alertPopup.classList.remove("flex");
}

/* ===== PRINT HELPERS ===== */
function renderPrint(){
 const d=JSON.parse(localStorage.getItem(printKey)||"{}");
 printHistory.innerHTML = Object.entries(d)
  .map(([b,q]) => `<div class="chat-item">${b},${q}</div>`)
  .join("");
}

function clearPrintHistory(){
 localStorage.removeItem(printKey);
 renderPrint();
}
</script>

</body>
</html>
