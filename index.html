<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HỆ THỐNG QUẢN LÝ HSD – Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

.chat-box{height:420px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;margin-bottom:6px;font-family:monospace}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer;font-size:13px}
.filter-btn.active{background:#2563eb;color:white;border-color:#2563eb}

#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- UI giữ nguyên hoàn toàn -->

<script>
/************************************
 * FIX & OPTIMIZE – KHÔNG ĐỔI UI
 * Safari iOS + Chrome Android
 * FPS 5 + Auto zoom + Auto refocus
 ************************************/

const historyKey="coop_hsd_history";
const printKey="coop_print_history";

let qr=null, qr2=null;
let scanTimer=null;
let lastScanned="";
let scanning=false;

/* ===== SCAN CONFIG – EAN-13 FMCG ===== */
const scanConfig={
 fps:5,
 aspectRatio:1.777,
 disableFlip:true,
 qrbox:(vw)=>{
  const w=Math.min(vw*0.9,320);
  return{width:w,height:w*0.32};
 },
 experimentalFeatures:{useBarCodeDetectorIfSupported:true},
 formatsToSupport:[Html5QrcodeSupportedFormats.EAN_13]
};

function safeStop(instance){
 if(instance && instance.isScanning){
  return instance.stop().then(()=>instance.clear()).catch(()=>{});
 }
 return Promise.resolve();
}

function scheduleRefocus(instance, starter){
 clearTimeout(scanTimer);
 scanTimer=setTimeout(()=>{
  if(instance && instance.isScanning) return;
  safeStop(instance).then(starter);
 },2000);
}

function startScan(){
 if(scanning) return;
 scanning=true;
 reader.classList.remove("hidden");
 if(!qr) qr=new Html5Qrcode("reader");
 lastScanned="";

 qr.start({facingMode:{ideal:"environment"}},scanConfig,code=>{
  if(code===lastScanned) return;
  if(!/^\d{13}$/.test(code)) return;
  lastScanned=code;
  barcode.value=code;
  scanning=false;
  safeStop(qr);
  reader.classList.add("hidden");
 }).then(()=>scheduleRefocus(qr,startScan))
 .catch(()=>{scanning=false;});
}

function startPrintScan(){
 if(scanning) return;
 scanning=true;
 printReader.classList.remove("hidden");
 if(!qr2) qr2=new Html5Qrcode("printReader");
 lastScanned="";

 qr2.start({facingMode:{ideal:"environment"}},scanConfig,code=>{
  if(code===lastScanned) return;
  if(!/^\d{13}$/.test(code)) return;
  lastScanned=code;
  addBarcode(code);
  scanning=false;
  safeStop(qr2);
  printReader.classList.add("hidden");
 }).then(()=>scheduleRefocus(qr2,startPrintScan))
 .catch(()=>{scanning=false;});
}

function closePopup(){
 clearTimeout(scanTimer);
 alertPopup.classList.add("hidden");
 alertPopup.classList.remove("flex");
}
</script>

</body>
</html>
