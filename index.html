<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saigon Co.op ‚Äì T√≠nh ng√†y l√πi h√†ng</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
:root{
  --coop-red:#d71920;
}
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.warning{color:#d71920;font-weight:700}
</style>
</head>

<body class="max-w-3xl mx-auto p-3">

<!-- HEADER -->
<header class="flex items-center gap-3 bg-white p-3 rounded-xl shadow mb-4">
  <img src="logo.png" class="h-10">
  <div>
    <h1 class="font-bold text-lg text-slate-800">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</h1>
    <div class="text-sm text-slate-500">T√≠nh ng√†y l√πi h√†ng ‚Äì Saigon Co.op</div>
  </div>
</header>

<!-- INPUT -->
<div class="card p-4 mb-4">
<h2 class="font-semibold text-slate-700 mb-3">1. Nh·∫≠p th√¥ng tin s·∫£n ph·∫©m</h2>

<div class="grid md:grid-cols-2 gap-3">

<div>
<label class="text-sm">Barcode</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="bg-[var(--coop-red)] text-white px-3 rounded">Qu√©t</button>
</div>
<div id="reader" class="mt-2"></div>
</div>

<div>
<label class="text-sm">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full mt-1">

<label class="text-sm mt-2 block">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full mt-1">
</div>

</div>

<button onclick="calculate()" class="mt-4 bg-[var(--coop-red)] text-white w-full py-2 rounded font-semibold">
T√çNH NG√ÄY L√ôI H√ÄNG
</button>
</div>

<!-- RESULT -->
<div class="card p-4 mb-4">
<h2 class="font-semibold text-slate-700 mb-2">2. K·∫øt qu·∫£ ƒë√°nh gi√°</h2>
<div id="result" class="text-lg"></div>
</div>

<!-- HISTORY -->
<div class="card p-4">
<div class="flex justify-between items-center mb-2">
<h2 class="font-semibold text-slate-700">3. L·ªãch s·ª≠ x·ª≠ l√Ω</h2>
<div class="flex gap-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white px-3 py-1 rounded text-sm">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white px-3 py-1 rounded text-sm">X√≥a</button>
</div>
</div>

<div id="history" class="text-sm max-h-64 overflow-auto space-y-1"></div>
</div>

<footer class="text-center text-xs text-slate-500 mt-4">
H·ªá th·ªëng n·ªôi b·ªô Saigon Co.op ‚Äì Kh√¥ng l∆∞u tr·ªØ h√¨nh ·∫£nh ng∆∞·ªùi d√πng
</footer>

<script>
const historyKey="coop_hsd_history";

function calculate(){
 if(!nsx.value||!hsd.value){alert("Vui l√≤ng nh·∫≠p ƒë·ªß NSX v√† HSD");return;}

 const nsxDate=new Date(nsx.value);
 const hsdDate=new Date(hsd.value);

 const total=(hsdDate-nsxDate)/(1000*3600*24);
 const limit=total*0.8;
 const display=new Date(nsxDate.getTime()+limit*86400000);

 const today=new Date();
 const warning=display<today;

 result.innerHTML=`
<div>Ng√†y tr∆∞ng b√†y cu·ªëi: <b>${display.toLocaleDateString()}</b></div>
${warning?'<div class="warning mt-1">‚ö† D∆∞·ªõi 20% HSD ‚Äì ƒë·ªÅ xu·∫•t x·ª≠ l√Ω theo quy ƒë·ªãnh</div>':'<div class="text-green-700 mt-1">‚úî C√≤n trong ng∆∞·ª°ng an to√†n</div>'}
`;

 saveHistory(display,warning);
}

function saveHistory(date,warning){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 h.unshift({
  barcode:barcode.value||"",
  nsx:nsx.value,
  hsd:hsd.value,
  display:date.toLocaleDateString(),
  status:warning?"D∆∞·ªõi 20%":"An to√†n",
  time:new Date().toLocaleString()
 });
 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 history.innerHTML=h.map(i=>`
<div class="border-b pb-1 ${i.status==="D∆∞·ªõi 20%"?"warning":""}">
üì¶ ${i.barcode||"---"} | ${i.display} | ${i.status} | ${i.time}
</div>
`).join("");
}

function clearHistory(){
 if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠?")){
  localStorage.removeItem(historyKey);
  renderHistory();
 }
}

function exportExcel(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!h.length){alert("Kh√¥ng c√≥ d·ªØ li·ªáu");return;}
 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"LichSu");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}

let qr;
function startScan(){
 reader.innerHTML="";
 qr=new Html5Qrcode("reader");
 qr.start({facingMode:"environment"},{fps:10,qrbox:250},
  code=>{barcode.value=code;qr.stop();},
  err=>{}
 );
}

renderHistory();
</script>

</body>
</html>
